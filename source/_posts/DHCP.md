---
title: DHCP
date: 2018-10-8
tags: protocol
---

## DHCP 协议
DHCP(Dynamic Host Configuration Protocol),动态主机配置协议，是一种用来配置设备参数的协议。最常见的配置参数是IP地址和DNS服务器。对于TCP/IP网络来说，每个接口都需要有IP地址，子网掩吗，和网关地址。这样才能进行正常通信。

### 消息格式
以下是DHCP消息格式， 它包括固定长度的头部和可变长度的尾部。

```
 0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
+---------------+---------------+---------------+---------------+
|                            xid (4)                            |
+-------------------------------+-------------------------------+
|           secs (2)            |           flags (2)           |
+-------------------------------+-------------------------------+
|                          ciaddr  (4)                          |
+---------------------------------------------------------------+
|                          yiaddr  (4)                          |
+---------------------------------------------------------------+
|                          siaddr  (4)                          |
+---------------------------------------------------------------+
|                          giaddr  (4)                          |
+---------------------------------------------------------------+
|                                                               |
|                          chaddr  (16)                         |
|                                                               |
|                                                               |
+---------------------------------------------------------------+
|                                                               |
|                          sname   (64)                         |
+---------------------------------------------------------------+
|                                                               |
|                          file    (128)                        |
+---------------------------------------------------------------+
|                                                               |
|                          options (variable)                   |
+---------------------------------------------------------------+
```
以上参数的详细介绍如下：
- op        消息类型(1-客户端请求, 2-服务端响应)
- htype     硬件地址类型，与ARP协议中的hardware filed相同。例如，1代表10Mbit的以太网。
- hlen      硬件地址长度。例如，在以太网中，硬件地址即MAC地址的长度为6。
- hops      客户端置为1， 可使用于中继代理。
- xid       传输ID。用于匹配一次请求和响应。
- secs      由客户端设置（单位为秒），用于标识IP地址请求或更新过程已使用的时间。
- flags     消息标记。
- ciaddr    客户端IP地址。仅用于BOUND，RENEW或REBINDING等能够响应ARP请求的状态。
- yiaddr    “你的”（客户端）IP地址。
- siaddr    bootstrap 中下一项服务的IP地址。
- giaddr    中继代理的IP地址。
- chaddr    客户端硬件地址。例如，以太网中的MAC地址。
- sname     可选的服务端主机名（无'\0'结尾的字符串）。
- file      启动文件名（无'\0'结尾的字符串）。
- option    可选参数区。

### 可选参数

根据[RFC2132](https://www.rfc-editor.org/rfc/rfc2132.txt)，DHCP可选参数中的格式如下。第一个字节是参数类型，如DNS服务器地址的参数类型为0x6;第二个字节是参数长度（不包括类型和长度字节）；随后是相应的参数。
```
Code   Len        Address 1  
+-----+-----+-----+-----+-----+-----+ --
|  6  |  n  |  a1 |  a2 |  a3 |  a4 |   ...
+-----+-----+-----+-----+-----+-----+ --
```
通过上述的了解，我们没有看到任何的防护机制。虽然[RFC3118](https://www.rfc-editor.org/rfc/rfc3118.txt),[RFC4030](https://www.rfc-editor.org/rfc/rfc4030.txt)中提出了认证DHCP消息的方法，但没有普及。DHCP协议一般部署在局域网中，所以相应的风险较低。

